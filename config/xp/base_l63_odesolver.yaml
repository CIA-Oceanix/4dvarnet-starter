# @package _global_

xp_name: baseline


datamodule:
  _target_: src.data_l63.BaseDataModule
  param_datamodule:
    dl_kw: {batch_size: 128, num_workers: 1}
  input_data:
    _target_: src.data_l63.create_l63_ode_solver_datasets #src.data_l63.create_l63_forecast_datasets
    param_dataset:
      path_l63_dataset: '../../Dataset4DVarNet/dataset_l63_normalized_20230717.nc' #'../../Dataset4DVarNet/dataset_L63_with_noise.nc'# '../../Dataset4DVarNet/dataset_L63_with_noise.nc'
      genSuffixObs: 'JamesData'
      flag_load_all_data: False
      flag_generate_L63_data: False #True #
      NbTraining: 10000
      NbTest: 1000
      time_step: ??
      dT: 4
      dT_test: 8
      dt_forecast: ??
      varNoise: 0.
      sampling_step: 1
      flagTypeMissData: -1
      
model:
  _target_: src.models_l63.Lit4dVarNet_L63_OdeSolver #src.models_l63.Lit4dVarNet_L63
  params:
    k_n_grad: ??
    n_grad: 10
    lr: 1e-3 
    batch_size: 128
    DimAE: 10 # ?? #
#    phi_param: 'unet'
#    solver: ?? #'4dvarnet-with-rnd' #?? #''4dvarnet-with-state-and-rnd' # #'4dvarnet-with-subgradients' #'4dvarnet-with-rnd-grad' #''4dvarnet-with-state-and-rnd' #
    dim_grad_solver: 10 #100 #25
    dropout: 0.
    alpha_prior: 0. #1e2
    alpha_mse: 1.e2
    alpha_gmse: 0. #50.
    alpha_var_cost_grad: 0.0
    lr_grad: ?? #1e-2 #1.e3
    lr_rnd: 0.e-3
    sig_rnd_init: 0.e-2
    sig_lstm_init: 0.e-2
    sig_obs_noise: 0. #1e-1
    init_state: 'ode_solver' # ?? #'zeros' #
    suffix_exp: ?? #'-lstm+grad' #'
    UsePeriodicBoundary: False
    degradation_operator: 'no-degradation'  #'gaussian_smoothing' #??  # 
    sig_perturbation_grad: 1e-2
    alpha_perturbation_grad: 0.9
    gamma_degradation: 1e-1
    type_step_lstm: 'linear-relu' #'constant'  #'linear'#
    param_lstm_step: 50 #20 #-1 #
    dt_mse_test: 10
    dt_mse: 0
    post_projection: False #True #  ?? # 
    post_median_filter: False # True # 
    median_filter_width: 3
    shapeData:
      - 3
      - ${datamodule.input_data.param_dataset.dT}
      - 1
    shapeData_modGrad: #${model.params.shapeData}
      - ${mul:${datamodule.input_data.param_dataset.dT},3} 
    dt_forecast: ${datamodule.input_data.param_dataset.dt_forecast}
    dT_test: ${datamodule.input_data.param_dataset.dT_test}
    time_step_ode: ${datamodule.input_data.param_dataset.time_step}
    base_ode_solver: 'euler'
    keep_obs: True
    use_rk4_gpu_as_target: True # False # 
#  ckpt: 'outputs/2023-06-10/23-30-37/base_l63/checkpoints/model-l63-lstmonly+gobs+grad-4dvarnet-with-state-and-rnd-JamesData-Obs20-Noise02-unet-igrad10_08-dgrad100-val_loss=8.5268-epoch=216.ckpt'
  Phi:
    _target_: src.models_l63.Phi_unet_like_bilin #src.models_l63.Phi_ode #src.models_l63.Phi_unet_1_layer_bis #src.models_l63.UNet_3_layers #
    shapeData: ${model.params.shapeData}
    DimAE: ${model.params.DimAE}
    name: 'unet-bilin'
#    rateDropout: 0.2
  m_NormObs:
    _target_: src.solver_l63.Model_WeightedL2Norm #src.solver_l63.Model_WeightedTrainableL2Norm #src.solver_l63.Model_WeightedGL2Norm # src.solver_l63.Model_WeightedL2Norm #
    #kernel_x: 5
    #kernel_y: 1
    #sigma: 1.
  m_NormPhi:
    _target_: src.solver_l63.Model_WeightedL2Norm
  mod_H:
    _target_: src.models_l63.Model_H # src.models_l63.Model_H_with_relu # src.models_l63.Model_HwithSSTBN_nolin_tanh #src.models_l63.Model_HwithTrainableLocalisation #src.models_l63.Model_HwithLocalisation
    shape_data: ${model.params.shapeData}
  mod_Grad:
    _target_: src.solver_l63.model_Grad_with_lstm
    ShapeData: ${model.params.shapeData_modGrad}
    DimLSTM: ${model.params.dim_grad_solver} 
    rateDropout: ${model.params.dropout} 
    sig_lstm_init: ${model.params.sig_lstm_init}
    name: 'lstm-grad'
  patch_weight:
    _target_: src.models_l63.get_forecasting_mask #get_forecastingonly_mask
    patch_dims: ${model.params.shapeData}
    dt_forecast: ${datamodule.input_data.param_dataset.dt_forecast}
    #dim: 5

trainer:
  _target_: pytorch_lightning.Trainer
  inference_mode: True
  #gradient_clip_val: 0.5
  accelerator: gpu
  devices: 1
  precision: 32
  logger: 
    _target_: pytorch_lightning.loggers.CSVLogger
    save_dir: ${hydra:runtime.output_dir}
    name: ${hydra:runtime.choices.xp}
    version: ''
  max_epochs: 400
  callbacks:
    - _target_: src.versioning_cb.VersioningCallback
    - _target_: pytorch_lightning.callbacks.LearningRateMonitor
    - _target_: pytorch_lightning.callbacks.ModelCheckpoint
      monitor: val_mse
      save_top_k: 3
      filename: 
        _target_: src.models_l63.create_filename_ckpt_odesolver #create_filename_ckpt
        suffix: '-{val_loss:.4f}-{epoch:03d}'#'{val_mse:.4f}-{epoch:03d}'
        params_data: ${datamodule.input_data.param_dataset}
        params_model: ${model.params}
        name_solver: ${model.mod_Grad.name}
        name_phi: ${model.Phi.name}
        
entrypoints:
  - _target_: pytorch_lightning.seed_everything
    seed: 333
  - _target_: src.train.base_training  # src.train.fine_tuning # 
    trainer: ${trainer}
    lit_mod: ${model}
    dm: ${datamodule}
#    update_params: False
#    ckpt: 'outputs/2023-06-08/23-38-13/base_l63/checkpoints/model-l63-lstmonly+gobs+grad-4dvarnet-with-rnd-JamesData-Obs20-Noise02-unet-igrad10_04-dgrad100-val_loss=15.7092-epoch=014.ckpt'
#    ckpt: 'outputs/2023-06-08/23-23-08/base_l63/checkpoints/model-l63-lstmonly+gobs-4dvarnet-with-rnd-JamesData-Obs20-Noise02-unet-igrad10_04-dgrad100-val_loss=9.7803-epoch=092.ckpt'
#    ckpt: 'outputs/2023-06-08/18-32-56/base_l63/checkpoints/model-l63-lstmonly+gobs-4dvarnet-with-rnd-JamesData-Obs20-Noise02-unet-igrad10_08-dgrad100-val_loss=8.8370-epoch=222.ckpt'
#    ckpt: 'outputs/2023-05-24/16-55-55/base_l63/checkpoints/model-l63-4dvarnet-with-state-and-rnd-JamesData-Obs08-Noise02-unet-igrad10_04-dgrad100-val_loss=3.2830-epoch=179.ckpt'
#    ckpt: 'outputs/2023-05-23/22-14-34/base_l63/checkpoints/model-l63-4dvarnet-with-state-and-rnd-JamesData-Obs08-Noise02-unet-igrad10_04-dgrad100-val_loss=3.0530-epoch=337.ckpt'
#    ckpt: 'outputs/2023-06-10/23-30-37/base_l63/checkpoints/model-l63-lstmonly+gobs+grad-4dvarnet-with-state-and-rnd-JamesData-Obs20-Noise02-unet-igrad10_08-dgrad100-val_loss=8.5268-epoch=216.ckpt'
#  - _target_: src.test.base_testing_ode_solver #src.test.base_testing_forecast #
#    trainer: ${trainer}
#    lit_mod: ${model}
#    dm: ${datamodule}
#    num_members: 0
#    ckpt: 'outputs/2023-07-19/23-56-13/base_l63_forecast/checkpoints/model-l63-l63data-forecast-dt3-dense-dT04-4dvarnet-with-rnd-JamesData-Obs01-Noise00-igrad10_04-dgrad10-val_loss=0.1779-epoch=382.ckpt'
#    ckpt: 'outputs/2023-07-19/11-43-27/base_l63_forecast/checkpoints/model-l63-l63data-forecast-unet-dt3-dT04-4dvarnet-with-rnd-JamesData-Obs01-Noise00-igrad10_04-dgrad10-val_loss=0.1043-epoch=377.ckpt'
#    ckpt: 'outputs/2023-07-18/23-06-57/base_l63_forecast/checkpoints/model-l63-l63-step2-forecast-dt3-dT04-4dvarnet-with-rnd-JamesData-Obs01-Noise00-igrad10_04-dgrad10-val_loss=0.2576-epoch=376.ckpt'
#    ckpt: 'outputs/2023-07-18/08-30-51/base_l63_forecast/checkpoints/model-l63-l63-forecast01-ode-dT04-4dvarnet-with-rnd-JamesData-Obs01-Noise00-igrad10_04-dgrad100-val_loss=40.1054-epoch=398.ckpt'
#    ckpt: 'outputs/2023-07-18/00-28-36/base_l63_forecast/checkpoints/model-l63-forecast-lstm-4dvarnet-with-rnd-JamesData-Obs01-Noise00-igrad10_08-dgrad100-val_loss=0.0464-epoch=258.ckpt'
#    ckpt: 'outputs/2023-07-18/00-08-31//base_l63_forecast/checkpoints/model-l63-new-l63data-forecast-4dvarnet-with-rnd-JamesData-Obs01-Noise00-igrad10_04-dgrad100-val_loss=0.0190-epoch=019.ckpt'
#    ckpt: 'outputs/2023-07-17/23-34-12/base_l63_forecast/checkpoints/model-l63-new-l63data-forecast-4dvarnet-with-rnd-JamesData-Obs01-Noise00-igrad10_04-dgrad100-val_loss=0.0036-epoch=043.ckpt'
#    test_fn:
#      _target_: src.utils.diagnostics
#      _partial_: true
#      test_domain:
#        time: {_target_: builtins.slice, _args_: ["2012-10-22", "2012-12-02"]}
#        lat: ${domain.test.lat}
#        lon: ${domain.test.lat}
  